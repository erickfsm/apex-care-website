<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Admin - Apex Care</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/style-improvements.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">
    <a href="relatorios.html" class="btn btn-secondary" style="margin-top: 20px;">
    üìä Ver Relat√≥rios Completos
</a>
    <style>
        .admin-main {
            padding-top: 120px;
            padding-bottom: 80px;
            background-color: var(--color-light-gray);
            min-height: 100vh;
        }

        .admin-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 8px;
            margin-bottom: 30px;
        }

        .admin-header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .stat-card {
            background-color: white;
            padding: 25px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            text-align: center;
            transition: all 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .stat-icon {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .stat-value {
            font-size: 2em;
            font-weight: 900;
            color: var(--color-cyan);
            margin: 10px 0;
        }

        .stat-label {
            font-size: 0.9em;
            color: #666;
            font-weight: 500;
        }

        .admin-tabs {
            display: flex;
            gap: 10px;
            margin: 30px 0;
            border-bottom: 2px solid #e5e7eb;
            overflow-x: auto;
        }

        .tab-btn {
            padding: 12px 20px;
            border: none;
            background-color: transparent;
            cursor: pointer;
            font-weight: 600;
            font-size: 1em;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .tab-btn.active {
            color: var(--color-cyan);
            border-bottom-color: var(--color-cyan);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .appointments-table {
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background-color: var(--color-graphite);
            color: white;
        }

        th {
            padding: 15px;
            text-align: left;
            font-weight: 700;
            font-size: 0.9em;
        }

        td {
            padding: 15px;
            border-bottom: 1px solid #e5e7eb;
        }

        tbody tr:hover {
            background-color: #f9fafb;
        }

        .action-btn {
            padding: 8px 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: 600;
            transition: all 0.2s;
            margin-right: 5px;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 6px 14px;
            border-radius: 999px;
            font-weight: 600;
            font-size: 0.85em;
        }

        .status-pendente { background-color: #fff4e5; color: #f57c00; }
        .status-confirmado { background-color: #e8f5e9; color: #2e7d32; }
        .status-em-andamento { background-color: #e0f7fa; color: #00838f; }
        .status-concluido { background-color: #dcedc8; color: #558b2f; }
        .status-cancelado { background-color: #ffebee; color: #c62828; }

        .btn-assign {
            background-color: var(--color-cyan);
            color: white;
        }

        .btn-assign:hover {
            background-color: #008f83;
        }

        .btn-view {
            background-color: #e5e7eb;
            color: var(--color-graphite);
        }

        .btn-view:hover {
            background-color: #d1d5db;
        }

        .btn-approve {
            background-color: #1b998b;
            color: white;
        }

        .btn-approve:hover {
            background-color: #0f5f55;
        }

        .btn-reject {
            background-color: #e53935;
            color: white;
        }

        .btn-reject:hover {
            background-color: #c62828;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .modal-header {
            font-size: 1.5em;
            font-weight: 700;
            margin-bottom: 20px;
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .modal-footer {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .form-group select,
        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .role-pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 999px;
            font-weight: 700;
            font-size: 0.8em;
            background-color: #e5e7eb;
            color: #111827;
        }

        .role-pill.tecnico {
            background-color: #e0f2fe;
            color: #0369a1;
        }

        .role-pill.tecnico_master {
            background-color: #ede9fe;
            color: #6d28d9;
        }

        .role-pill.tecnico_master::before {
            content: '‚òÖ';
            font-size: 0.75em;
        }

        .role-pill.admin {
            background-color: #fee2e2;
            color: #b91c1c;
        }

        .role-pill.cliente {
            background-color: #ecfdf5;
            color: #047857;
        }

        .modal-note {
            font-size: 0.85em;
            color: #555;
            margin-top: 8px;
            line-height: 1.4;
        }

        @media (max-width: 768px) {
            .admin-header h1 {
                font-size: 1.5em;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .appointments-table {
                overflow-x: auto;
            }

            table {
                font-size: 0.85em;
            }

            th, td {
                padding: 10px;
            }
        }
    </style>
</head>
<body>

    <header class="main-header scrolled">
        <nav class="main-nav">
            <a href="index.html" class="logo">
                <img src="assets/images/logo-apex-care.svg" alt="Logo Apex Care">
            </a>
            <ul>
                <li><a href="index.html">Site</a></li>
            </ul>
            <div id="auth-container-header" class="auth-container-header"></div>
        </nav>
    </header>

    <main class="admin-main">
        <div class="container">
            
            <!-- CABE√áALHO ADMIN -->
            <div class="admin-header">
                <h1>üéõÔ∏è Dashboard Administrativo</h1>
                <p>Vis√£o completa do seu neg√≥cio Apex Care</p>
            </div>

            <!-- ESTAT√çSTICAS -->
            <div class="stats-grid" id="admin-stats">
                <div class="stat-card">
                    <div class="stat-icon">üìÖ</div>
                    <div class="stat-value" id="total-agendamentos">0</div>
                    <div class="stat-label">Total de Agendamentos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">‚è≥</div>
                    <div class="stat-value" id="pendentes">0</div>
                    <div class="stat-label">Pendentes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">‚úÖ</div>
                    <div class="stat-value" id="concluidos">0</div>
                    <div class="stat-label">Conclu√≠dos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üí∞</div>
                    <div class="stat-value" id="receita-total">R$ 0</div>
                    <div class="stat-label">Receita Total</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üéØ</div>
                    <div class="stat-value" id="promocoes-convertidas">0</div>
                    <div class="stat-label">Promo√ß√µes Convertidas</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üè∑Ô∏è</div>
                    <div class="stat-value" id="descontos-concedidos">R$ 0</div>
                    <div class="stat-label">Descontos Concedidos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üë•</div>
                    <div class="stat-value" id="total-clientes">0</div>
                    <div class="stat-label">Total de Clientes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üîß</div>
                    <div class="stat-value" id="total-tecnicos">0</div>
                    <div class="stat-label">T√©cnicos Ativos</div>
                </div>
            </div>

            <!-- ABAS -->
            <div class="admin-tabs">
                <button class="tab-btn active" onclick="switchTab('agendamentos', this)">üìã Agendamentos</button>
                <button class="tab-btn" onclick="switchTab('tecnicos', this)">üîß T√©cnicos</button>
                <button class="tab-btn" onclick="switchTab('clientes', this)">üë• Clientes</button>
                <button class="tab-btn" onclick="switchTab('financeiro', this)">üí∞ Financeiro</button>
            </div>

            <!-- TAB: AGENDAMENTOS -->
            <div id="agendamentos" class="tab-content active">
                <div class="appointments-table">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Cliente</th>
                                <th>Data</th>
                                <th>T√©cnico</th>
                                <th>Status</th>
                                <th>Valor</th>
                                <th>Deslocamento</th>
                                <th>Condi√ß√µes / Observa√ß√µes</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="appointments-tbody">
                            <tr>
                                <td colspan="9" style="text-align: center; padding: 40px;">Carregando...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- TAB: T√âCNICOS -->
            <div id="tecnicos" class="tab-content">
                <div class="appointments-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Email</th>
                                <th>WhatsApp</th>
                                <th>Servi√ßos Ativos</th>
                                <th>Servi√ßos Conclu√≠dos</th>
                                <th>Fun√ß√£o</th>
                                <th>Gerenciar</th>
                            </tr>
                        </thead>
                        <tbody id="tecnicos-tbody">
                            <tr>
                                <td colspan="7" style="text-align: center; padding: 40px;">Carregando...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- TAB: CLIENTES -->
            <div id="clientes" class="tab-content">
                <div class="appointments-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Email</th>
                                <th>WhatsApp</th>
                                <th>Endere√ßo</th>
                                <th>Total Gasto</th>
                                <th>Fun√ß√£o</th>
                                <th>Gerenciar</th>
                            </tr>
                        </thead>
                        <tbody id="clientes-tbody">
                            <tr>
                                <td colspan="7" style="text-align: center; padding: 40px;">Carregando...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- TAB: FINANCEIRO -->
            <div id="financeiro" class="tab-content">
                <div style="background-color: white; padding: 30px; border-radius: 8px;">
                    <h3>üìä Relat√≥rio Financeiro</h3>
                    <div id="financial-report">Carregando relat√≥rio...</div>
                </div>
            </div>

        </div>
    </main>

    <!-- MODAL: ATRIBUIR T√âCNICO -->
    <div id="assign-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">Atribuir T√©cnico</div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="select-tecnico">Selecione o T√©cnico:</label>
                    <select id="select-tecnico">
                        <option value="">Carregando...</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="action-btn btn-view" onclick="closeModal()">Cancelar</button>
                <button class="action-btn btn-assign" onclick="confirmAssignment()">Atribuir</button>
            </div>
        </div>
    </div>

    <div id="user-role-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">Gerenciar acesso do usu√°rio</div>
            <div class="modal-body">
                <p><strong>Usu√°rio:</strong> <span id="user-role-name">-</span></p>
                <p><strong>Fun√ß√£o atual:</strong> <span id="user-role-current">-</span></p>
                <div class="form-group">
                    <label for="user-role-select">Nova fun√ß√£o</label>
                    <select id="user-role-select">
                        <option value="">Selecione</option>
                        <option value="cliente">Cliente</option>
                        <option value="tecnico">T√©cnico</option>
                        <option value="tecnico_master">T√©cnico Master</option>
                        <option value="admin">Administrador</option>
                    </select>
                </div>
                <p id="user-role-description" class="modal-note">Selecione o n√≠vel de acesso desejado.</p>
            </div>
            <div class="modal-footer">
                <button class="action-btn btn-view" onclick="closeUserRoleModal()">Cancelar</button>
                <button class="action-btn btn-assign" onclick="updateUserRole()">Salvar altera√ß√µes</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { supabase } from './js/supabase-client.js';

        let currentUser = null;
        let allAppointments = [];
        let allTechnicians = [];
        let allClients = [];
        let selectedAppointmentId = null;
        let managedUser = null;
        let promotionUsage = [];
        let promocoesManager = null;

        const ROLE_LABELS = {
            cliente: 'Cliente',
            tecnico: 'T√©cnico',
            tecnico_master: 'T√©cnico Master',
            admin: 'Administrador'
        };

        const ROLE_DESCRIPTIONS = {
            cliente: 'Acesso ao portal do cliente, or√ßamentos e agendamentos.',
            tecnico: 'Acesso ao painel t√©cnico, sem visibilidade de valores.',
            tecnico_master: 'Combina o painel t√©cnico com atalhos discretos para a √°rea administrativa.',
            admin: 'Controle total: aprova or√ßamentos, gerencia campanhas e acessa relat√≥rios.'
        };

        const DEFAULT_ROLE_HELP = 'Selecione o n√≠vel de acesso desejado.';

        const userRoleModal = document.getElementById('user-role-modal');
        const userRoleNameEl = document.getElementById('user-role-name');
        const userRoleCurrentEl = document.getElementById('user-role-current');
        const roleSelect = document.getElementById('user-role-select');
        const roleDescriptionEl = document.getElementById('user-role-description');
        const assignModal = document.getElementById('assign-modal');

        const formatCurrency = (value) => `R$ ${(Number(value) || 0).toFixed(2).replace('.', ',')}`;
        const escapeHtml = (value) => {
            if (value === null || value === undefined) return '';
            return value
                .toString()
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        };

        function normalizeRole(role) {
            return (role || '').toString().toLowerCase();
        }

        function getRoleLabel(role) {
            return ROLE_LABELS[normalizeRole(role)] || 'Definir';
        }

        function formatRolePill(role) {
            const normalized = normalizeRole(role) || 'indefinido';
            const label = getRoleLabel(role);
            return `<span class="role-pill ${normalized}">${label}</span>`;
        }

        function updateRoleDescription(role) {
            if (!roleDescriptionEl) return;
            const normalized = normalizeRole(role);
            roleDescriptionEl.textContent = ROLE_DESCRIPTIONS[normalized] || DEFAULT_ROLE_HELP;
        }

        if (roleSelect) {
            roleSelect.addEventListener('change', (event) => {
                updateRoleDescription(event.target.value);
            });
            updateRoleDescription(roleSelect.value);
        }

        if (userRoleModal) {
            userRoleModal.addEventListener('click', (event) => {
                if (event.target === userRoleModal) {
                    closeUserRoleModal();
                }
            });
        }

        if (assignModal) {
            assignModal.addEventListener('click', (event) => {
                if (event.target === assignModal && typeof window.closeModal === 'function') {
                    window.closeModal();
                }
            });
        }

        // Inicializa√ß√£o
        async function init() {
            const { data: { user } } = await supabase.auth.getUser();
            
            if (!user) {
                alert('Acesso negado.');
                window.location.href = 'login.html';
                return;
            }

            // Verificar se √© admin
            const { data: profile } = await supabase
                .from('profiles')
                .select('user_type')
                .eq('id', user.id)
                .single();

            const allowedRoles = ['admin', 'tecnico_master'];
            if (!allowedRoles.includes(profile?.user_type)) {
                alert('Acesso negado. Apenas administradores autorizados podem acessar esta p√°gina.');
                window.location.href = 'index.html';
                return;
            }

            currentUser = user;
            if (window?.PromocoesManager) {
                promocoesManager = new window.PromocoesManager();
            }
            await loadAllData();
        }

        async function loadAllData() {
            await Promise.all([
                loadAppointments(),
                loadTechnicians(),
                loadClients(),
                loadPromotionUsage()
            ]);
            updateStats();
        }

        async function loadAppointments() {
            const { data, error } = await supabase
                .from('agendamentos')
                .select(`
                    *,
                    cliente:profiles!cliente_id (
                        nome_completo,
                        email,
                        whatsapp
                    ),
                    tecnico:profiles!tecnico_id (
                        nome_completo
                    )
                `)
                .order('created_at', { ascending: false });

            if (error) {
                console.error('Erro ao carregar agendamentos:', error);
                return;
            }

            allAppointments = data || [];
            renderAppointmentsTable();
        }

        async function loadTechnicians() {
            const { data, error } = await supabase
                .from('profiles')
                .select('*')
                .in('user_type', ['tecnico', 'tecnico_master']);

            if (error) {
                console.error('Erro ao carregar t√©cnicos:', error);
                return;
            }

            allTechnicians = data || [];
            renderTechniciansTable();
            populateTechnicianSelect();
        }

        async function loadClients() {
            const { data, error } = await supabase
                .from('profiles')
                .select('*')
                .eq('user_type', 'cliente');

            if (error) {
                console.error('Erro ao carregar clientes:', error);
                return;
            }

            allClients = data || [];
            renderClientsTable();
        }

        async function loadPromotionUsage() {
            const { data, error } = await supabase
                .from('promocoes_uso')
                .select('*');

            if (error) {
                console.error('Erro ao carregar uso de promo√ß√µes:', error);
                promotionUsage = [];
                return;
            }

            promotionUsage = data || [];
        }

        function updateStats() {
            // Total de agendamentos
            document.getElementById('total-agendamentos').textContent = allAppointments.length;

            // Pendentes
            const pendentes = allAppointments.filter(a => 
                a.status_pagamento !== 'Conclu√≠do' && a.status_pagamento !== 'Cancelado'
            ).length;
            document.getElementById('pendentes').textContent = pendentes;

            // Conclu√≠dos
            const concluidos = allAppointments.filter(a => 
                a.status_pagamento === 'Conclu√≠do'
            ).length;
            document.getElementById('concluidos').textContent = concluidos;

            // Receita total
            const receitaTotal = allAppointments
                .filter(a => ['Pago e Confirmado', 'Conclu√≠do', 'Pendente (Pagar no Local)', 'Em Andamento', 'Aguardando Execu√ß√£o'].includes(a.status_pagamento))
                .reduce((sum, a) => sum + (a.valor_total || 0), 0);
            document.getElementById('receita-total').textContent = formatCurrency(receitaTotal);

            // Total de clientes
            document.getElementById('total-clientes').textContent = allClients.length;

            // T√©cnicos ativos
            document.getElementById('total-tecnicos').textContent = allTechnicians.length;

            const totalPromocoes = promotionUsage.length;
            const totalDescontos = promotionUsage.reduce((sum, uso) => {
                return sum + (Number(uso?.valor_desconto) || 0);
            }, 0);

            const promocoesConvertidasEl = document.getElementById('promocoes-convertidas');
            if (promocoesConvertidasEl) {
                promocoesConvertidasEl.textContent = totalPromocoes;
            }

            const descontosConcedidosEl = document.getElementById('descontos-concedidos');
            if (descontosConcedidosEl) {
                descontosConcedidosEl.textContent = formatCurrency(totalDescontos);
            }
        }

        function shouldRegistrarPromocao(status) {
            const candidatos = ['Aprovado', 'Aguardando Agendamento', 'Pago e Confirmado'];
            return candidatos.includes(status);
        }

        function renderAppointmentsTable() {
            const tbody = document.getElementById('appointments-tbody');
            
            if (allAppointments.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 40px;">Nenhum agendamento encontrado</td></tr>';
                return;
            }

            tbody.innerHTML = '';
            allAppointments.forEach(appt => {
                const clienteNome = appt.cliente?.nome_completo || 'N/A';
                const tecnicoNome = appt.tecnico?.nome_completo || 'N√£o atribu√≠do';
                const dataFormatada = appt.data_agendamento
                    ? new Date(appt.data_agendamento + 'T00:00:00').toLocaleDateString('pt-BR')
                    : 'Sem data';
                const statusBadge = `<span class="status-badge ${getStatusClass(appt.status_pagamento)}">${appt.status_pagamento}</span>`;
                const valorFormatado = formatCurrency(appt.valor_total);

                const distanciaValue = Number(appt.distancia_km);
                const distanciaTexto = Number.isFinite(distanciaValue)
                    ? `${distanciaValue.toFixed(1)} km`
                    : '‚Äî';
                const taxaValue = Number(appt.taxa_deslocamento) || 0;
                const adicionaisValue = Number(appt.adicionais_condicoes) || 0;

                const deslocamentoResumo = `
                    <ul class="table-meta-list">
                        <li><span class="meta-label">Dist√¢ncia:</span> ${distanciaTexto}</li>
                        <li><span class="meta-label">Taxa:</span> ${formatCurrency(taxaValue)}</li>
                        <li><span class="meta-label">Adicionais:</span> ${formatCurrency(adicionaisValue)}</li>
                    </ul>
                `;

                const condicoesLabels = Array.isArray(appt.condicoes_extremas?.selections)
                    ? appt.condicoes_extremas.selections
                        .map(item => item?.label || item?.id)
                        .filter(Boolean)
                    : [];
                const condicoesTexto = condicoesLabels.length ? condicoesLabels.join(', ') : '';
                const observacoesTexto = (appt.observacoes || '').trim();
                const backofficeTexto = (appt.anotacoes_backoffice || '').trim();

                const condicoesItens = [];
                if (condicoesTexto) {
                    condicoesItens.push(`<li><span class="meta-label">Condi√ß√µes:</span> ${escapeHtml(condicoesTexto)}</li>`);
                }
                if (observacoesTexto) {
                    condicoesItens.push(`<li><span class="meta-label">Observa√ß√µes:</span> ${escapeHtml(observacoesTexto)}</li>`);
                }
                if (backofficeTexto) {
                    condicoesItens.push(`<li><span class="meta-label">Backoffice:</span> ${escapeHtml(backofficeTexto)}</li>`);
                }
                if (!condicoesItens.length) {
                    condicoesItens.push('<li>‚Äî</li>');
                }

                const condicoesResumo = `<ul class="table-meta-list">${condicoesItens.join('')}</ul>`;

                const actionButtons = [
                    `<button class="action-btn btn-assign" onclick="openAssignModal('${appt.id}')">Atribuir</button>`,
                    `<button class="action-btn btn-view" onclick="viewAppointment('${appt.id}')">Ver</button>`
                ];

                if (appt.status_pagamento === 'Em Aprova√ß√£o') {
                    actionButtons.push(`<button class="action-btn btn-approve" onclick="updateBudgetStatus('${appt.id}', 'Aprovado')">Aprovar</button>`);
                    actionButtons.push(`<button class="action-btn btn-reject" onclick="updateBudgetStatus('${appt.id}', 'Reprovado')">Reprovar</button>`);
                } else if (appt.status_pagamento === 'Aprovado' && !appt.data_agendamento) {
                    actionButtons.push(`<button class="action-btn btn-approve" onclick="updateBudgetStatus('${appt.id}', 'Aguardando Agendamento')">Liberar agenda</button>`);
                } else if (appt.status_pagamento === 'Reprovado') {
                    actionButtons.push(`<button class="action-btn btn-approve" onclick="updateBudgetStatus('${appt.id}', 'Em Aprova√ß√£o')">Reabrir</button>`);
                }

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>#${appt.id}</td>
                    <td>${clienteNome}</td>
                    <td>${dataFormatada}</td>
                    <td>${tecnicoNome}</td>
                    <td>${statusBadge}</td>
                    <td>${valorFormatado}</td>
                    <td>${deslocamentoResumo}</td>
                    <td>${condicoesResumo}</td>
                    <td>${actionButtons.join(' ')}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function renderTechniciansTable() {
            const tbody = document.getElementById('tecnicos-tbody');

            if (allTechnicians.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px;">Nenhum t√©cnico cadastrado</td></tr>';
                return;
            }

            tbody.innerHTML = '';
            allTechnicians.forEach(tech => {
                // Contar servi√ßos do t√©cnico
                const servicosAtivos = allAppointments.filter(a =>
                    a.tecnico_id === tech.id &&
                    a.status_pagamento !== 'Conclu√≠do' &&
                    a.status_pagamento !== 'Cancelado'
                ).length;

                const servicosConcluidos = allAppointments.filter(a =>
                    a.tecnico_id === tech.id &&
                    a.status_pagamento === 'Conclu√≠do'
                ).length;

                const rolePill = formatRolePill(tech.user_type);
                const manageButton = `<button class="action-btn btn-assign" onclick="openUserRoleModal('${tech.id}')">Gerenciar</button>`;
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${tech.nome_completo || 'N/A'}</td>
                    <td>${tech.email || 'N/A'}</td>
                    <td>${tech.whatsapp || 'N/A'}</td>
                    <td>${servicosAtivos}</td>
                    <td>${servicosConcluidos}</td>
                    <td>${rolePill}</td>
                    <td>${manageButton}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function renderClientsTable() {
            const tbody = document.getElementById('clientes-tbody');

            if (allClients.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px;">Nenhum cliente cadastrado</td></tr>';
                return;
            }

            tbody.innerHTML = '';
            allClients.forEach(client => {
                // Calcular total gasto
                const totalGasto = allAppointments
                    .filter(a => a.cliente_id === client.id && a.status_pagamento !== 'Cancelado')
                    .reduce((sum, a) => sum + (a.valor_total || 0), 0);

                const rolePill = formatRolePill(client.user_type);
                const manageButton = `<button class="action-btn btn-assign" onclick="openUserRoleModal('${client.id}')">Gerenciar</button>`;
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${client.nome_completo || 'N/A'}</td>
                    <td>${client.email || 'N/A'}</td>
                    <td>${client.whatsapp || 'N/A'}</td>
                    <td>${client.endereco || 'N/A'}</td>
                    <td>${formatCurrency(totalGasto)}</td>
                    <td>${rolePill}</td>
                    <td>${manageButton}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function populateTechnicianSelect() {
            const select = document.getElementById('select-tecnico');
            if (!select) return;
            select.innerHTML = '<option value="">Selecione um t√©cnico</option>';

            allTechnicians.forEach(tech => {
                const option = document.createElement('option');
                option.value = tech.id;
                const labelBase = tech.nome_completo || tech.email || 'T√©cnico';
                const isMaster = normalizeRole(tech.user_type) === 'tecnico_master';
                option.textContent = isMaster ? `${labelBase} ‚Ä¢ Master` : labelBase;
                select.appendChild(option);
            });
        }

        function findUserById(userId) {
            if (!userId) return null;
            const collection = [...allTechnicians, ...allClients];
            return collection.find(user => user.id === userId) || null;
        }

        function resetUserRoleModalState() {
            if (roleSelect) {
                roleSelect.value = '';
            }
            if (userRoleNameEl) {
                userRoleNameEl.textContent = '-';
            }
            if (userRoleCurrentEl) {
                userRoleCurrentEl.textContent = '-';
            }
            updateRoleDescription('');
        }

        function openUserRoleModal(userId) {
            if (!userRoleModal) return;

            const user = findUserById(userId);

            if (!user) {
                alert('Usu√°rio n√£o encontrado.');
                return;
            }

            managedUser = { ...user };

            if (userRoleNameEl) {
                userRoleNameEl.textContent = user.nome_completo || user.email || 'Usu√°rio';
            }

            if (userRoleCurrentEl) {
                userRoleCurrentEl.textContent = getRoleLabel(user.user_type);
            }

            if (roleSelect) {
                roleSelect.value = user.user_type || '';
                updateRoleDescription(roleSelect.value);
            }

            userRoleModal.classList.add('active');
        }

        function closeUserRoleModal() {
            if (userRoleModal) {
                userRoleModal.classList.remove('active');
            }
            managedUser = null;
            resetUserRoleModalState();
        }

        async function updateUserRole() {
            if (!managedUser) {
                alert('Selecione um usu√°rio para atualizar.');
                return;
            }

            if (!roleSelect) {
                alert('Seletor de fun√ß√£o indispon√≠vel.');
                return;
            }

            const newRole = roleSelect.value;

            if (!newRole) {
                alert('Selecione uma fun√ß√£o para continuar.');
                return;
            }

            const normalizedNewRole = normalizeRole(newRole);
            const previousRole = normalizeRole(managedUser.user_type);

            if (normalizedNewRole === previousRole) {
                alert('O usu√°rio j√° possui essa fun√ß√£o.');
                return;
            }

            try {
                const { error } = await supabase
                    .from('profiles')
                    .update({ user_type: normalizedNewRole })
                    .eq('id', managedUser.id);

                if (error) throw error;

                alert('Fun√ß√£o atualizada com sucesso!');
                closeUserRoleModal();
                await loadAllData();
            } catch (error) {
                console.error('Erro ao atualizar usu√°rio:', error);
                alert('N√£o foi poss√≠vel atualizar o acesso: ' + error.message);
            }
        }

        function getStatusClass(status) {
            const map = {
                'Em Aprova√ß√£o': 'status-pendente',
                'Aprovado': 'status-confirmado',
                'Aguardando Agendamento': 'status-confirmado',
                'Pendente': 'status-pendente',
                'Pendente (Pagar no Local)': 'status-pendente',
                'Pago e Confirmado': 'status-confirmado',
                'Aguardando Execu√ß√£o': 'status-confirmado',
                'Em Andamento': 'status-em-andamento',
                'Conclu√≠do': 'status-concluido',
                'Cancelado': 'status-cancelado',
                'Reprovado': 'status-cancelado'
            };
            return map[status] || 'status-pendente';
        }

        // Fun√ß√µes globais
        window.openUserRoleModal = openUserRoleModal;
        window.closeUserRoleModal = closeUserRoleModal;
        window.updateUserRole = updateUserRole;

        window.switchTab = function(tabName, button) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));

            document.getElementById(tabName).classList.add('active');
            button.classList.add('active');
        };

        window.openAssignModal = function(appointmentId) {
            selectedAppointmentId = appointmentId;
            document.getElementById('assign-modal').classList.add('active');
        };

        window.closeModal = function() {
            document.getElementById('assign-modal').classList.remove('active');
            selectedAppointmentId = null;
        };

        window.confirmAssignment = async function() {
            const tecnicoId = document.getElementById('select-tecnico').value;
            
            if (!tecnicoId) {
                alert('Por favor, selecione um t√©cnico.');
                return;
            }

            try {
                const { error } = await supabase
                    .from('agendamentos')
                    .update({ tecnico_id: tecnicoId })
                    .eq('id', selectedAppointmentId);

                if (error) throw error;

                alert('T√©cnico atribu√≠do com sucesso!');
                closeModal();
                await loadAllData();
            } catch (error) {
                console.error('Erro ao atribuir t√©cnico:', error);
                alert('Erro ao atribuir t√©cnico: ' + error.message);
            }
        };

        window.viewAppointment = function(appointmentId) {
            window.location.href = `tecnico-painel.html?os=${appointmentId}`;
        };

        window.updateBudgetStatus = async function(appointmentId, newStatus) {
            try {
                const appointment = allAppointments.find(appt => appt.id === appointmentId);

                const payload = {
                    status_pagamento: newStatus
                };

                if (['Em Aprova√ß√£o', 'Aprovado', 'Aguardando Agendamento', 'Reprovado'].includes(newStatus)) {
                    payload.data_agendamento = null;
                    payload.hora_agendamento = null;
                }

                const { error } = await supabase
                    .from('agendamentos')
                    .update(payload)
                    .eq('id', appointmentId);

                if (error) throw error;

                if (appointment && shouldRegistrarPromocao(newStatus)) {
                    try {
                        if (!promocoesManager && window?.PromocoesManager) {
                            promocoesManager = new window.PromocoesManager();
                        }

                        if (promocoesManager) {
                            await registrarUsoPromocaoSeAplicavel(promocoesManager, appointment, {
                                clienteId: appointment.cliente_id,
                            });
                        }
                    } catch (registroError) {
                        console.error('Erro ao registrar uso da promo√ß√£o ap√≥s atualiza√ß√£o:', registroError);
                    }
                }

                alert('Status do or√ßamento atualizado com sucesso!');
                await loadAllData();
            } catch (error) {
                console.error('Erro ao atualizar status:', error);
                alert('N√£o foi poss√≠vel atualizar o status. Tente novamente.');
            }
        };

        // Iniciar
        init();
    </script>

    <script type="module" src="js/shared-improved.js"></script>

    <footer class="main-footer">
        <div class="container footer-grid">
            <div class="footer-col">
                <img src="assets/images/logo-apex-care-white.svg" alt="Logo Apex Care" class="footer-logo">
                <p>Performance que traz tranquilidade.</p>
            </div>
            <div class="footer-col">
                <h4>Contato</h4>
                <ul>
                    <li><a href="https://wa.me/55SEUDDDSEUNUMERO" target="_blank">WhatsApp</a></li>
                    <li><a href="mailto:contato@apexcare.com.br">E-mail</a></li>
                </ul>
            </div>
        </div>
        <div class="footer-bottom">
            <p>&copy; 2025 Apex Care. Todos os direitos reservados.</p>
        </div>
    </footer>

</body>
</html>